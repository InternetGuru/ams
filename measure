#!/bin/bash

#set -x

measure() {
  # shellcheck disable=SC2155
  declare -r user_projects_folder="$(mktemp -d)"
  # get all branches
  git fetch --all >/dev/null
  # for all branches get user projects
  declare user_projects
  declare group_id
  declare namespace
  for namespace in ${NAMESPACE}; do
    group_id="$(get_group_id "${namespace}" 2>/dev/null)"
    [[ -z "${group_id}" ]] \
      && continue
    user_projects="$(get_group_projects)" \
      || exit 1
    # clone all user_projects from ns
    for user_project_ns in ${user_projects}; do
      [[ -n "${PREFIX}" && "$(basename "${user_project_ns}")" != "$PREFIX"* ]] \
        && continue
      mkdir -p "${user_projects_folder}/${user_project_ns}"
      git_clone "$(get_remote_url)" "${user_projects_folder}/{$user_project_ns}"
    done
  done
  # allow **/*
  shopt -s globstar
  # send projects into moss
  ./moss -l "${CAM_LANG}" -d "${user_projects_folder}"/**/src/main/**/*."${CAM_LANG}" \
    "${WORKING_DIR}"/src/main/**/*."${CAM_LANG}"
}

declare -r CAM_LANG='java'
declare PREFIX=''
declare NAMESPACE=''

# get options
declare OPT
OPT="$(getopt --name "${0}" --options 'hp:s:' \
  --longoptions 'help,prefix:,namespace:' \
  -- "$@")" \
  && eval set -- "${OPT}" \
  || exit 1

# process options
while (( $# > 0 )); do
  case "${1}" in
    -h|--help) print_usage && exit 0 ;;
    -p|--prefix) PREFIX="${2}"; shift; shift ;;
    -s|--namespace) NAMESPACE="${NAMESPACE} ${2}"; shift; shift ;;
    --) shift; break ;;
     *) break ;;
  esac
done

measure
